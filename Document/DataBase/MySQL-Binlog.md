# MySQL Binlog

## 概述

> MySQL的二进制日志（Binary Log，简称binlog）是MySQL数据库引擎提供的一种记录数据库更改的机制，它包含了对数据库执行的所有修改操作，并以二进制格式记录在一个特定的日志文件中，主要用于数据库数据恢复和主从复制以及审计操作

## 内容

> binlog包含了对数据库执行的所有修改操作，如`插入` `更新` `删除`，并记录了语句`发生时间` `执行时间 ` `执行时长` `操作数据`等其他额外信息

## 作用

### 恢复数据

> binlog允许数据库管理员在系统崩溃或数据损坏的情况下进行数据恢复，通过重新执行binlog中的事务，可以还原数据库到崩溃之前的状态，也可基于备份文件，结合binlog将数据库恢复至某一时间点，或复制数据到其他数据库

### 主从辅助

> binlog是MySQL主从复制机制的核心，在主从复制模式下主数据库必须开启binlog，主数据库记录所有的写操作，而从数据库通过读取主数据库的binlog来同步数据，这种机制用于创建备份、提高系统可用性以及分担读负载

### 审计操作

> Binlog中包含了数据库中所有更改的详细信息，包括执行的SQL语句和相关的元数据，这使得管理员可以追踪和审计数据库操作，了解谁、什么时间、在哪个主机上执行了何种操作

## 模式

### statement

#### 概述

> 在statement模式下，MySQL会将执行的原生SQL语句记录到二进制日志中，当在主服务器上执行一个修改数据的操作时，该操作的SQL语句将被记录到binlog，而在从服务器上进行复制时，这些SQL语句将在从服务器上再次执行

#### 优点

> 因为记录的是SQL和执行语句时的上下文信息，不需要记录每一行数据的变化，所以采用该格式的二进制文件最小，节省IO，主从复制占用带宽低，性能最高

#### 缺点

> 由于记录的是原生SQL和执行时上下文信息，如果SQL中使用了`UUID()` `NOW()`等这样的不确定函数，可能在主从服务器上产生不同的结果，从而导致主从数据库数据不一致的问题，同时基于binlog进行数据恢复和复制也将会收到影响

### row

#### 概述

> 在row模式下，MySQL会将实际的数据行变更(更改前和更改后)记录到二进制日志中，无论进行何种修改，都会以数据行的形式记录下来，而不是记录SQL语句

#### 优点

> 日志详细记录了数据变更前和变更后的的数据细节，提供了更高的安全性和可靠性，因为记录的是实际数据行的变更，避免了某些SQL语句可能导致的问题，适用于那些容易出现主从不一致问题的情况

#### 缺点

> 由于记录的是每行数据的变更情况，所以二进制文件内容较多，占用存储空间
>
> 新版本MySQL做了优化，如遇到像表结构变更时，就会以statement模式来记录

### mixed

#### 概述

> mixed是一种混合模式，在mixed模式下，MySQL会根据执行的具体操作来选择是`statement`或`row`模式来进行记录
>
> MySQL会在特定情况下自动从statement模式切换到row模式
>
> 1. SQL使用了UUID(),NOW()等不确定函数
> 2. 使用了insert,delay语句
> 3. 使用了用户自定义函数UDF
> 4. 使用了临时表

#### 优点

> 兼顾了Statement和Row模式的优点，具有较小的日志量和较高的安全性

#### 缺点

> 复杂的语句可能仍然选择记录数据行的变更，导致相对较大的日志量

## 配置项

### 开启Binlog

```
[mysqld]
log_bin=/path/binlog/mysql-binlog
```

### binlog模式

```
[mysqld]
binlog_format=ROW
# STATEMENT
# ROW(default)
# MIXED
```

### binlog索引文件

```
[mysqld]
log_bin_index=/path/binlog/binlog_index
```

### binlog过期时间(单位:秒)

``` 
[mysqld]
binlog_expire_logs_seconds=2592000
```

### binlog文件大小

```
[mysqld]
max_binlog_size=1G
```

### row数据行格式

```
[mysqld]
binlog_row_image=FULL
# FULL(defualt) 在二进制日志中记录完整的行数据，包括所有列的值
# MINIMAL 在二进制日志中记录行的变更，但只包含发生变更的列及其新值
# NOBLOB 在二进制日志中记录行的变更，但不包含 BLOB 列的内容
```

### binlog刷新策略

```
[mysqld]
sync_binlog=1
```
