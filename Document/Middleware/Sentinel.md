# Sentinel



---



[Sentinel官网](https://sentinelguard.io/zh-cn/index.html)



---



### Sentinel线程隔离



> Senitnel有两种线程隔离方式，一种是基于信号量，另一种是基于线程池
>



##### 信号量隔离

信号量隔离（Semaphore Isolation）：通过信号量实现资源的隔离，为每个受保护的资源设置一个信号量计数器，限制并发访问的数量，当并发请求超过信号量的阈值时，Sentinel将拒绝额外的请求，这种隔离方式适用于轻量级资源的保护，如方法调用、数据库连接等

**优点：**

1. 适用于低扇出场景
2. 信号量隔离相对较为轻量级，不需要额外的线程池资源
3. 由于不需要线程切换和线程池管理的开销，信号量隔离可以在保证资源隔离的同时，具有较低的延迟

**缺点：**

1. 不能异步调用
2. 由于信号量隔离并未使用独立的线程池，无法对执行超时的请求进行限制。如果某个请求发生阻塞或耗时过长，可能会对整体系统的响应性能产生影响
3. 所有请求共享同一个线程，如果某个请求的资源消耗较高，可能会影响其他请求的执行



##### 线程池隔离

线程池隔离（Thread Pool Isolation）：通过线程池实现资源的隔离，将不同的资源分配到不同的线程池中执行，确保资源之间的相互独立性，每个资源都有一个独立的线程池来处理请求，当某个资源的线程池达到最大并发量时，Sentinel将拒绝额外的请求，这种隔离方式适用于对资源消耗较大的操作，如网络调用、远程接口等

**优点：**

1. 适用于高扇出场景
2. 可以异步调用
3. 通过设置线程池的最大并发数，可以限制每个资源的并发请求数量，从而保护资源免受过载的影响
4. 控制执行时间：线程池隔离可以通过设置超时时间，对执行时间过长的请求进行限制，防止请求长时间阻塞
5. 每个资源都有一个独立的线程池，可以确保资源之间的相互独立性，一个资源的问题不会影响其他资源的执行

**缺点：**

1. 线程池的创建和管理会占用一定的系统资源，特别是当需要隔离大量资源时，可能会对系统的资源消耗产生影响
2. 线程池本身是一个系统资源，如果线程池出现问题（如线程池饱和、线程池中的线程发生异常），会影响到所有使用线程池的资源



---



### Sentinel熔断降级



##### 熔断降级概念

> 熔断降级是一种用于保护系统免受故障和异常的影响的机制。当系统中的某个组件或服务出现故障或异常时，熔断降级可以在一定程度上限制对该组件或服务的访问，以避免故障的进一步扩散，保证系统的稳定性和可靠性。
>
> 熔断降级的主要目的是在故障发生时，快速失败或降级处理请求，以避免系统雪崩效应的发生。雪崩效应指的是当系统中的一个组件或服务故障时，大量的请求涌入，导致整个系统的性能和可用性急剧下降，甚至导致系统崩溃。



##### 断路器

熔断降级中的断路器（Circuit Breaker）可以处于三种状态：关闭状态（Closed）、打开状态（Open）和半开状态（Half-Open）

1. 关闭状态（Closed）：在初始状态或恢复期间，断路器处于关闭状态。此时，所有的请求都会正常通过断路器，并执行相应的逻辑。断路器会监控请求的指标（如错误比例、响应时间等），如果这些指标超过预设的阈值，断路器将进入打开状态
2. 打开状态（Open）：当断路器进入打开状态时，它会迅速拦截请求，避免继续访问故障的资源或服务。此时，断路器会将请求快速失败，并执行预设的熔断逻辑，例如返回默认的响应、降级处理等。打开状态的持续时间可以根据设定的时间窗口进行配置
3. 半开状态（Half-Open）：在打开状态一段时间后，断路器会进入半开状态。在半开状态下，断路器会允许部分请求通过，并将这些请求发送到资源或服务进行测试。如果测试请求成功返回，断路器将认为资源已经恢复正常，切换回关闭状态；如果测试请求失败，断路器将重新进入打开状态，继续拦截请求

断路器的状态转换如下：

- 初始状态为关闭状态（Closed）
- 如果请求的指标超过预设的阈值，断路器将进入打开状态（Open）
- 在打开状态一段时间后，断路器将进入半开状态（Half-Open）
- 在半开状态下，根据测试请求的结果，断路器会切换回关闭状态（Closed）或再次进入打开状态（Open）

断路器的状态转换通常由一定的策略和算法来决定，可以根据系统的需求和实际情况进行调整和配置。断路器的状态切换旨在保护系统免受故障的进一步扩散，并在故障恢复后逐渐恢复正常的请求流量



### 熔断降级步骤



![Sentinel熔断降级1](..\Img\Sentinel熔断降级1.png)



熔断降级一共有三种策略

1. 基于满调用比例，当请求超过最大RT将被识别为慢调用，当慢调用超出比例阈值时，会对资源进行熔断降级

   ![Sentinel熔断降级2](..\img\Sentinel熔断降级2.png)

2. 基于异常比例，当请求资源抛出异常时，会被识别为异常调用，当异常调用超出比例阈值时，会对资源进行熔断降级

   ![Sentinel熔断降级3](..\img\Sentinel熔断降级3.png)

3. 基于异常数，当异常请求数量超过限定数量时，会对资源进行熔断降级

   ![Sentinel熔断降级4](..\img\Sentinel熔断降级4.png)

​	

---



